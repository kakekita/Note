<!doctype html>
<html lang="ja">
  <head>
    <style>
      #mainCVS {
        background-color: mintcream;
        display: block;
      }
      
      html, body, #wrapper{
	      width: 100%;
	      height: 100%;
      }
    </style>
  </head>
  <body>
    <input type="file" id="file_Select">
    <div id="wrapper">
      <canvas id="mainCVS"></canvas>
    </div>
    <script>
      var mc = document.getElementById("mainCVS");
      var ct = mc.getContext('2d');
      var wr = document.getElementById("wrapper");
      var file_sel = document.getElementById("file_Select");
      mc.width = wr.offsetWidth;
      mc.height =  wr.offsetHeight;
      var data = null;
      
      document.body.addEventListener('keydown', function(e) {
        if(e.ctrlKey) {
          if(e.shiftKey) {
            if(e.code === "KeyS"){
              save();
            }
          }
        }
      },false);
      
      file_sel.addEventListener("change", load);
      
      function save() {
        let write_json=JSON.stringify(data);
        let blob=new Blob([write_json], {type: 'application/json'});
        let a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        var name = prompt("ファイル名","");
        a.download = name+'.json';
        a.click();
        URL.revokeObjectURL(a.href);
      }
      
      function load() {
        if(!(file_sel.value)) return; // ファイルが選択されない場合
        var file_list=file_sel.files;
        if(!file_list) return; // ファイルリストが選択されない場合
        var file=file_list[0];
        if(!file) return; // ファイルが無い場合
        
        var file_reader=new FileReader();
        file_reader.readAsText(file);
        file_reader.onload=function(){
          data = JSON.parse(file_reader.result);
          //var write_json=JSON.stringify(data);
          //localStorage.setItem('id_back', write_json);
          //location.reload();
          drawCanvas();
        };
        
        function drawCanvas() {
          for(var k in data) {
            var d = data[k];
            var text = d["text"];
            var txw = ct.measureText(text);
            /*先に背景ボックスを描画*/
            ct.fillStyle = '#008C22';
            ct.fillRect(parseInt(d["x"])-txw.width/2,parseInt(d["y"]),txw.width,20);
            /*あんまりピッタリでもアレなので、5pxの線の四角形で囲んでみた*/
            ct.strokeStyle = '#008C22';
            ct.lineWidth = 5;
            ct.strokeRect(parseInt(d["x"])-txw.width/2,parseInt(d["y"]),txw.width,20);
            /*テキストを描画*/
            ct.fillStyle = '#fff';
            ct.textBaseline = 'middle';
            ct.fillText(text,parseInt(d["x"]),parseInt(d["y"]));
          }
        }
        
      }
    </script>
  </body>
</html>
