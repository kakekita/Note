<!doctype html>
<html lang="ja">
  <head>
    <style>
      #note pre {
        outline: none;
        font-size: 24px;
        border: none;
        tab-size: 12;
        width: 100%;
        height: 100%;
        background-color: white;
        white-space: pre-wrap;
      }
      
      #note {
        width: 480px;
        height: 640px;
        overflow-y: scroll;
      }
      
      body {
        background-color: lightgray;
      }
    </style>
  </head>
  <body>
    <div id="note">
      <pre contenteditable id="textarea1"></pre>
    </div>
    <script>
      
      function OnTabKey( e, obj ){

        // タブキーが押された時以外は即リターン
        if( e.keyCode!=9 && e.keyCode != 8){ return; }

        // タブキーを押したときのデフォルトの挙動を止める
        e.preventDefault();
        
        if(e.keyCode == 9) {
          // 現在のカーソルの位置と、カーソルの左右の文字列を取得しておく
          var cursorPosition = window.getSelection().getRangeAt(0).getBoundingClientRect();
          var cursorLeft     = obj.innerHTML.substr( 0, cursorPosition );
          var cursorRight    = obj.innerHTML.substr( cursorPosition, obj.innerHTML.length );
          var [line,len] = getCursorLinePos(cursorPosition,obj.innerHTML);
          // テキストエリアの中身を、
          // 「取得しておいたカーソルの左側」+「タブ」+「取得しておいたカーソルの右側」
          // という状態にする。
          
          var lineSplit = obj.innerHTML.split("\n");
          
          if(lineSplit[line].indexOf("・") == -1) {
            obj.innerHTML = cursorLeft+"&#009;・"+cursorRight;
            // カーソルの位置を入力したタブの後ろにする
            setFocus(obj.innerHTML.indexOf("・")+1);
          }else {
            lineSplit[line] = lineSplit[line].replace("・","&#009;・");
            obj.innerHTML = lineSplit.join("\n");
            setFocus(cursorPosition+1);
          }
        }
        
        if(e.keyCode == 8) {
          var cursorPosition = window.getSelection().getRangeAt(0).getBoundingClientRect()
          var cursorLeft     = obj.innerHTML.substr( 0, cursorPosition );
          var cursorRight    = obj.innerHTML.substr( cursorPosition, obj.innerHTML.length );
          
          var dot = cursorLeft.split("")[cursorPosition-1];
          var t = cursorLeft.split("")[cursorPosition-2];
          if(dot == "・"&&t == "&#009;") {
            cursorLeft = cursorLeft.replace("&#009;・","・");
            obj.innerHTML = cursorLeft+cursorRight;
          }else {
            cursorLeft = cursorLeft.slice(0,-1);
            obj.innerHTML = cursorLeft+cursorRight;
          }
        }
      }

      // 対象となるテキストエリアにonkeydownイベントを追加する
      document.getElementById( "textarea1" ).onkeydown = function( e ){ OnTabKey( e, this ); }
      
      function getCursorLinePos(pos, text){
        const lines = text.split("\n");
        const charCounts = lines.map((line)=> line.length+1);
        if(charCounts.length>0 && charCounts[0]>0){ charCounts[0]-=1; }
        let cur = 0;
        let sum = 0;
        for(let i=0; i<charCounts.length; i++){
          sum += charCounts[i];
          if(pos <= sum){
            cur = i;
            break;
          }
        }
        return [cur, lines.length];
      }
      
      function setFocus(pos) {
        var selection = window.getSelection();    //Selectionインスタンスの取得
        var range = document.createRange();       //Rangeインスタンスを生成する

        //選択範囲の開始・終了位置を設定する
        let  el  =  document.getElementById("textarea1");
        range.setStart(el, pos);  //①
        range.setEnd(el, pos);    //②

        //現在の選択範囲をすべて解除
        selection.removeAllRanges(); 

        //上の処理で作成した選択範囲(range)を追加する
        selection.addRange(range);
      }
      
      function disableScroll(event) {
        event.preventDefault();
      }

      // イベントと関数を紐付け
      document.addEventListener('touchmove', disableScroll, { passive: false });
    </script>
  </body>
</html>
