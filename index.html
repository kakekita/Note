<!doctype html>
<html lang="ja">
  <head>
    <style>
      #note div {
        outline: none;
        font-size: 24px;
        border: none;
        tab-size: 12;
        width: 100%;
        height: 100%;
        background-color: white;
      }
      
      #note {
        width: 600px;
        height: 750px;
        text-align: center;
        overflow-y: scroll;
      }
      
      body {
        background-color: lightgray;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="note">
      <div contenteditable id="textarea1"></div>
    </div>
    <script>
      
      function OnTabKey( e, obj ){

        // タブキーが押された時以外は即リターン
        if( e.keyCode!=9 && e.keyCode != 8){ return; }

        // タブキーを押したときのデフォルトの挙動を止める
        e.preventDefault();
        
        if(e.keyCode == 9) {
          // 現在のカーソルの位置と、カーソルの左右の文字列を取得しておく
          var cursorPosition = window.getSelection().getRangeAt(0).getBoundingClientRect();
          var cursorLeft     = obj.value.substr( 0, cursorPosition );
          var cursorRight    = obj.value.substr( cursorPosition, obj.value.length );
          var [line,len] = getCursorLinePos(cursorPosition,obj.value);
          // テキストエリアの中身を、
          // 「取得しておいたカーソルの左側」+「タブ」+「取得しておいたカーソルの右側」
          // という状態にする。
          
          var lineSplit = obj.value.split("\n");
          
          if(lineSplit[line].indexOf("・") == -1) {
            obj.innerHTML = cursorLeft+"\t・"+cursorRight;
            // カーソルの位置を入力したタブの後ろにする
            obj.selectionEnd = obj.value.indexOf("・")+1;
          }else {
            lineSplit[line] = lineSplit[line].replace("・","\t・");
            obj.innerHTML = lineSplit.join("\n");
            obj.selectionEnd = obj.cursorPosition+1;
          }
        }
        
        if(e.keyCode == 8) {
          var cursorPosition = window.getSelection().getRangeAt(0).getBoundingClientRect()
          var cursorLeft     = obj.value.substr( 0, cursorPosition );
          var cursorRight    = obj.value.substr( cursorPosition, obj.value.length );
          
          var dot = cursorLeft.split("")[cursorPosition-1];
          var t = cursorLeft.split("")[cursorPosition-2];
          if(dot == "・"&&t == "\t") {
            cursorLeft = cursorLeft.replace("\t・","・");
            obj.innerHTML = cursorLeft+cursorRight;
          }else {
            cursorLeft = cursorLeft.slice(0,-1);
            obj.innerHTML = cursorLeft+cursorRight;
          }
        }
      }

      // 対象となるテキストエリアにonkeydownイベントを追加する
      document.getElementById( "textarea1" ).onkeydown = function( e ){ OnTabKey( e, this ); }
      
      function getCursorLinePos(pos, text){
        const lines = text.split("\n");
        const charCounts = lines.map((line)=> line.length+1);
        if(charCounts.length>0 && charCounts[0]>0){ charCounts[0]-=1; }
        let cur = 0;
        let sum = 0;
        for(let i=0; i<charCounts.length; i++){
          sum += charCounts[i];
          if(pos <= sum){
            cur = i;
            break;
          }
        }
        return [cur, lines.length];
      }
      
      
      function disableScroll(event) {
        event.preventDefault();
      }

      // イベントと関数を紐付け
      document.addEventListener('touchmove', disableScroll, { passive: false });
    </script>
  </body>
</html>
