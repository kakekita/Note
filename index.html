<!doctype html>
<html lang="ja">
  <head>
    <style>
      #wrapper{
        width: 1000px;
        height: 500px;
        background-color: lightgray;
        position: relative;
        display: block
      }
      
      .drag-and-drop {
        cursor: move;
        position: absolute;
        z-index: 1000;
      }

      .drag {
        z-index: 1001;
      }
      
      html, body {
        overflow: hidden;
        zoom: 100%;
      }
      
      .ex2{
          display: flex;
      }
      .ex2 label{
          display: block;
          width: 80px;
          background: #c8eac3;
          color: #000;
          padding: 10px;
          margin: 10px;
          box-sizing: border-box;
          text-align: center;
          text-decoration: none;
          border-radius: 30px;
          cursor: pointer;
      }
      .ex2 input:checked+label{
          background: #1a720d;
          color: #FFF;
      }
      .ex2 input{
          display: none;
      }
      
    </style>
  </head>
  <body>
    <input type="file" id="file_Select">
    <textarea id="textarea" rows="5" cols="33"></textarea><button id="textDraw" onclick="addTexts()">決定</button>
    <div class="ex2">
      <input type="radio" checked id="11" name="ex2"><label for="11">文字</label>
      <input type="radio" id="12" name="ex2"><label for="12">背景</label>
      <input type="radio" id="13" name="ex2"><label for="13">枠線</label>
    </div>
    <div id="wrapper">
      
    </div>
    <script>
      var wr = document.getElementById("wrapper");
      var file_sel = document.getElementById("file_Select");
      var ta = document.getElementById("textarea");
      var data = null;
      
      document.body.addEventListener('keydown', function(e) {
        if(e.ctrlKey) {
          if(e.shiftKey) {
            if(e.code === "KeyS"){
              save();
            }
          }
        }
      },false);
      
      file_sel.addEventListener("change", load);
      
      function save() {
        /*
        let write_json=JSON.stringify(data);
        let blob=new Blob([write_json], {type: 'application/json'});
        let a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        var name = prompt("ファイル名","");
        a.download = name+'.json';
        a.click();
        URL.revokeObjectURL(a.href);
        */
        
        let blob=new Blob([wr.innerHTML], {type: 'text/plain'});
        let a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        var name = prompt("ファイル名","");
        a.download = name+'.txt';
        a.click();
        URL.revokeObjectURL(a.href);
      }
      
      function load() {
        if(!(file_sel.value)) return; // ファイルが選択されない場合
        var file_list=file_sel.files;
        if(!file_list) return; // ファイルリストが選択されない場合
        var file=file_list[0];
        if(!file) return; // ファイルが無い場合
        
        var file_reader=new FileReader();
        file_reader.readAsText(file);
        file_reader.onload=function(){
          //data = JSON.parse(file_reader.result);
          wr.innerHTML = file_reader.result;
          //drawTexts();
          moveSettings();
        };
      }
        
      
      function addTexts() {
        var t = ta.value;
        var ele = document.createElement("div");
        //ele.style.position = "absolute";
        ele.id = String(wr.childElementCount);
        ele.textContent = t;
        ele.style.backgroundColor = "cornsilk";
        ele.style.left = "100px";
        ele.style.top = "150px";
        ele.classList.add("drag-and-drop");
        
        if(t != "") {
          wr.append(ele);
          alert(t);
        }
        
        moveSettings();
      }
      
      function moveSettings(){

        //要素の取得
        var elements = document.getElementsByClassName("drag-and-drop");

        //要素内のクリックされた位置を取得するグローバル（のような）変数
        var x;
        var y;

        //マウスが要素内で押されたとき、又はタッチされたとき発火
        for(var i = 0; i < elements.length; i++) {
            elements[i].addEventListener("mousedown", mdown, false);
            elements[i].addEventListener("touchstart", mdown, false);
        }

        //マウスが押された際の関数
        function mdown(e) {

            //クラス名に .drag を追加
            this.classList.add("drag");

            //タッチデイベントとマウスのイベントの差異を吸収
            if(e.type === "mousedown") {
                var event = e;
            } else {
                var event = e.changedTouches[0];
            }

            //要素内の相対座標を取得
            x = event.pageX - this.offsetLeft;
            y = event.pageY - this.offsetTop;
            //alert(String(x)+","+String(y));
            //ムーブイベントにコールバック
            wr.addEventListener("mousemove", mmove, false);
            wr.addEventListener("touchmove", mmove, false);
          
            
        }

        //マウスカーソルが動いたときに発火
        function mmove(e) {

            //ドラッグしている要素を取得
            var drag = document.getElementsByClassName("drag")[0];

            //同様にマウスとタッチの差異を吸収
            if(e.type === "mousemove") {
                var event = e;
            } else {
                var event = e.changedTouches[0];
            }

            //フリックしたときに画面を動かさないようにデフォルト動作を抑制
            e.preventDefault();

            //マウスが動いた場所に要素を動かす
            drag.style.top = event.pageY - y + "px";
            drag.style.left = event.pageX - x + "px";

            //マウスボタンが離されたとき、またはカーソルが外れたとき発火
            drag.addEventListener("mouseup", mup, false);
            wr.addEventListener("mouseleave", mup, false);
            drag.addEventListener("touchend", mup, false);
            wr.addEventListener("touchleave", mup, false);

        }

        //マウスボタンが上がったら発火
        function mup(e) {
            var drag = document.getElementsByClassName("drag")[0];

            //ムーブベントハンドラの消去
            wr.removeEventListener("mousemove", mmove, false);
            drag.removeEventListener("mouseup", mup, false);
            wr.removeEventListener("touchmove", mmove, false);
            drag.removeEventListener("touchend", mup, false);

            //クラス名 .drag も消す
            drag.classList.remove("drag");
        }

      }
      
      function disableScroll(event) {
        event.preventDefault();
      }

      // イベントと関数を紐付け
      document.addEventListener('touchmove', disableScroll, { passive: false });
    </script>
  </body>
</html>
